app.controller('createOrEditISController', ['$scope', '$location', '$window', '$http', '$routeParams', 'usSpinnerService', 'commonService', '$filter', 'dbConfigService',
    function ($scope, $location, $window, http, $routeParams, spinner, commonService, $filter, configSevice) {
        /* Config */
        //$scope.viewId = $routeParams.id;
        $scope.section1 = true;
        $scope.section2 = false;
        $scope.section3 = false;
        $scope.section4 = false;
        $scope.section5 = false;
        $scope.section6 = false;
        $scope.section7 = false;
        $scope.doc = {};
        $scope.General = {};
        $scope.doc.contains = [];
        $scope.doc.containerObj = [];
        init();
        $scope.popup1 = {};
        $scope.importDate = {};
        $scope.invDate = {};
        $scope.importDue = {};
        $scope.feederVslOn = {};
        $scope.igmDate = {};
        $scope.hblDate = {};
        $scope.mbldate = {};
        $scope.dateOptions = {
            dateDisabled: false,
            formatYear: 'yy',
            maxDate: new Date(2020, 5, 22),
            //minDate: new Date(),
            startingDay: 1
        };
        $scope.yearValue = configSevice.getJobid();
        $scope.formats = ['dd-MMMM-yyyy', 'yyyy/MM/dd', 'dd.MM.yyyy', 'shortDate'];
        $scope.format = $scope.formats[2];

        function decodeSlash(jobid) {
            jobid = jobid.replace(/[?]/g, "/");
            return jobid;
        }
        $scope.open = function (value) {
            switch (value) {
                case 1:
                    $scope.importDate.open = true;
                    break;
                case 2:
                    $scope.invDate.open = true;
                    break;
                case 3:
                    $scope.importDue.open = true;
                    break;
                case 4:
                    $scope.feederVslOn.open = true;
                    break;
                case 5:
                    $scope.igmDate.open = true;
                    break;
                case 6:
                    $scope.hblDate.open = true;
                    break;
                case 7:
                    $scope.mbldate.open = true;
                    break;
                default:
                    $scope.importDate.open = false;
            };
        };
        function init() {
            $routeParams.id = decodeSlash($routeParams.id);
            spinner.spin('spinner-1');
            var url = configSevice.getUrl() + "import_sea/import_sea_service.php";
            if ($routeParams.id === "CREATE") {
                //$scope.doc.importJobNo = "";
                $scope.type = "create";
                $scope.createFlag = true;
                // $scope.disableJobId = true;
                // $scope.doc.importJobNo = "AutoGenerated";
                $scope.updateFlag = false;
                spinner.stop('spinner-1');
            } else {
                $scope.type = "update";
                $scope.createFlag = false;
                $scope.updateFlag = true;
                $scope.doc.importJobNo = $routeParams.id; //+ configSevice.getJobid();
                var obj = {
                    module: "importsea",
                    action: "view_import_sea_doc",
                    id: $routeParams.id,
                    type: "sea"
                };
                http.post(url, obj).then(function (response) {
                    if (angular.isDefined(response.data) && response.data.result === true) {
                        $scope.getImportseaData = response.data.data;
                        mapFieldsWithgetObj($scope.getImportseaData);
                        spinner.stop('spinner-1');
                    } else {
                        $scope.errorMsg = response.data.msg;
                        $(showError).modal("show");
                        spinner.stop('spinner-1');
                    }
                });
            }
        }

        function mapGeneralType(obj) {
            if (obj.jobType !== null && angular.isDefined(obj.jobType) && obj.jobType !== "") {
                $scope.General = JSON.parse(obj.jobType);
            }
        }
        function setDateFields(contrNos) {
            if (angular.isArray(contrNos)) {
                for (var i = 0; i < contrNos.length; i++) {
                    contrNos[i].gld = new Date(contrNos[i].gld);
                    contrNos[i].contrOut = new Date(contrNos[i].contrOut);
                }
            }
            return contrNos;
        }
        function mapContents(obj) {

            if (obj.contrNos !== "" && obj.contrNos !== null) {
                obj.contrNos = JSON.parse(obj.contrNos);
                $scope.doc.contains = setDateFields(obj.contrNos);
                if (angular.isArray($scope.doc.contains)) {
                    $scope.doc.containerNumber = $scope.doc.contains.length;
                }
            }
            if (obj.noOfPkgs !== null && angular.isDefined(obj.noOfPkgs)) {
                $scope.doc.noOfPkgs = obj.noOfPkgs;
            }
            if (obj.content !== null && angular.isDefined(obj.content)) {
                $scope.doc.contents = obj.content;
            }
            if (obj.measurements !== null && angular.isDefined(obj.measurements)) {
                $scope.doc.measurements = obj.measurements;
            }
            if (obj.grossWeight !== null && angular.isDefined(obj.grossWeight)) {
                $scope.doc.grossWeight = obj.grossWeight;
            }
            if (obj.nettWeight !== null && angular.isDefined(obj.nettWeight)) {
                $scope.doc.nettWeight = obj.nettWeight;
            }
        }

        function mapFieldsWithgetObj(getObj) {
            var obj = getObj.importSeaDoc.docFields[0];
            if (angular.isDefined(getObj.importSeaDoc.contents)) {
                var ContentObj = getObj.importSeaDoc.contents[0];
                mapContents(ContentObj);
            }
            // if (angular.isDefined(obj.impJobId) && obj.impJobId !== null) {
            //   $scope.doc.importJobNo = obj.impJobId;
            // }
            mapGeneralType(obj);

            if (angular.isDefined(obj.importedDate) && obj.importedDate !== null) {
                $scope.doc.importDate = new Date(obj.importedDate);
            }
            if (angular.isDefined(obj.partyRef) && obj.partyRef !== null) {
                $scope.doc.partyRef = obj.partyRef;
            }
            if (angular.isDefined(obj.consignee) && obj.consignee !== null) {
                $scope.doc.consignee = obj.consignee;
            }
            if (angular.isDefined(obj.licenseDetail) && obj.licenseDetail !== null) {
                $scope.doc.licnse = obj.licenseDetail;
            }
            if (angular.isDefined(obj.buffNo) && obj.buffNo !== null) {
                $scope.doc.buffNo = obj.buffNo;
            }
            if (angular.isDefined(obj.address) && obj.address !== null) {
                $scope.doc.address = obj.address;
            }
            if (angular.isDefined(obj.hsOrBtAccParty) && obj.hsOrBtAccParty !== null) {
                $scope.doc.hsBtAcParty = obj.hsOrBtAccParty;
            }
            if (angular.isDefined(obj.supplier) && obj.supplier !== null) {
                $scope.doc.supplierName = obj.supplier;
            }
            if (angular.isDefined(obj.invoiceNo) && obj.invoiceNo !== null) {
                $scope.doc.invno = obj.invoiceNo;
            }
            if (angular.isDefined(obj.invoiceDate) && obj.invoiceDate !== null) {
                $scope.doc.invDate = new Date(obj.invoiceDate);
            }
            if (angular.isDefined(obj.content) && obj.content !== null && obj.content.length > 0) {
                $scope.doc.contains = obj.content;
            }
            if (angular.isDefined(obj.motherVsl) && obj.motherVsl !== null) {
                $scope.doc.motherVessel = obj.motherVsl;
            }
            if (angular.isDefined(obj.mvdate) && obj.mvdate !== null) {
                $scope.doc.importDue = new Date(obj.mvdate);
            }
            if (angular.isDefined(obj.arrival) && obj.arrival !== null) {
                $scope.doc.importArrival = obj.arrival;
            }
            if (angular.isDefined(obj.gld) && obj.gld !== null) {
                $scope.doc.importGld = obj.gld;
            }
            if (angular.isDefined(obj.cntrOut) && obj.cntrOut !== null) {
                $scope.doc.importContrOut = obj.cntrOut;
            }
            if (angular.isDefined(obj.feederVsl) && obj.feederVsl !== null) {
                $scope.doc.feederVessel = obj.feederVsl;
            }
            if (angular.isDefined(obj.fvOn) && obj.fvOn !== null) {
                $scope.doc.feederVslOn = new Date(obj.fvOn);
            }
            if (angular.isDefined(obj.CFS) && obj.CFS !== null) {
                $scope.doc.cfs = obj.CFS;
            }
            if (angular.isDefined(obj.agents) && obj.agents !== null) {
                $scope.doc.agents = obj.agents;
            }
            if (angular.isDefined(obj.igmNo) && obj.igmNo !== null) {
                $scope.doc.igmNo = parseInt(obj.igmNo);
            }
            if (angular.isDefined(obj.licenseDate) && obj.licenseDate !== null) {
                $scope.doc.igmDate = new Date(obj.licenseDate);
            }
            if (angular.isDefined(obj.lineNo) && obj.lineNo !== null) {
                $scope.doc.lineNo = obj.lineNo;
            }
            if (angular.isDefined(obj.hblNo) && obj.hblNo !== null) {
                $scope.doc.hblNo = obj.hblNo;
            }
            if (angular.isDefined(obj.hblDate) && obj.hblDate !== null) {
                $scope.doc.hblDate = new Date(obj.hblDate);
            }
            if (angular.isDefined(obj.mbl) && obj.mbl !== null) {
                $scope.doc.mbl = obj.mbl;
            }
            if (angular.isDefined(obj.mblDate) && obj.mblDate !== null) {
                $scope.doc.mbldate = new Date(obj.mblDate);
            }
            if (angular.isDefined(obj.invoiceValue) && obj.invoiceValue !== null) {
                $scope.doc.invoiceValue = obj.invoiceValue;
            }
        }

        function setDocNoFields(obj, action) {
            obj.module = "importSea";
            obj.action = action;
            obj.type = "sea";
            obj.Container.type = "sea";
            if ($routeParams.id !== 'CREATE') {
                obj.id = $routeParams.id;
            }
            if (angular.isDefined($scope.doc.importJobNo) && $scope.doc.importJobNo !== null) {
                obj.impJobId = $scope.doc.importJobNo;
            }
            if (angular.isDefined($scope.doc.importDate) && $scope.doc.importDate !== null) {
                obj.importedDate = $filter('date')($scope.doc.importDate, "yyyy-MM-dd");
            }
            if (angular.isDefined($scope.doc.partyRef) && $scope.doc.partyRef !== null) {
                obj.partyRef = $scope.doc.partyRef;
            }
            if (angular.isDefined($scope.doc.licnse) && $scope.doc.licnse !== null) {
                obj.licenseDetail = $scope.doc.licnse;
            }
            if (angular.isDefined($scope.doc.buffNo) && $scope.doc.buffNo !== null) {
                obj.buffNo = $scope.doc.buffNo;
            }
            if (angular.isDefined($scope.doc.consignee) && $scope.doc.consignee !== null) {
                obj.consignee = $scope.doc.consignee;
            }
            if (angular.isDefined($scope.doc.address) && $scope.doc.address !== null) {
                obj.address = $scope.doc.address;
            }
            if (angular.isDefined($scope.doc.hsBtAcParty) && $scope.doc.hsBtAcParty !== null) {
                obj.hsOrBtAccParty = $scope.doc.hsBtAcParty;
            }
            if (angular.isDefined($scope.doc.supplierName) && $scope.doc.supplierName !== null) {
                obj.supplier = $scope.doc.supplierName;
            }
            if (angular.isDefined($scope.doc.invno) && $scope.doc.invno !== null) {
                obj.invoiceNo = $scope.doc.invno;
            }
            if (angular.isDefined($scope.doc.invDate) && $scope.doc.invDate !== null) {
                obj.invoiceDate = $filter('date')($scope.doc.invDate, "yyyy-MM-dd");
            }
            if (angular.isDefined($scope.doc.contains) && $scope.doc.contains.length > 0) {
                $scope.doc.contains = mapDateFields($scope.doc.contains);
                obj.Container.Contr = JSON.stringify($scope.doc.contains);
            }
            if (angular.isDefined($scope.doc.noOfPkgs) && $scope.doc.noOfPkgs !== null) {
                obj.Container.noOfPkgs = $scope.doc.noOfPkgs;
            }
            if (angular.isDefined($scope.doc.contents) && $scope.doc.contents !== null) {
                obj.Container.content = $scope.doc.contents;
            }
            if (angular.isDefined($scope.doc.measurements) && $scope.doc.measurements !== null) {
                obj.Container.measurements = $scope.doc.measurements;
            }
            if (angular.isDefined($scope.doc.grossWeight) && $scope.doc.grossWeight !== null) {
                obj.Container.grossWeight = $scope.doc.grossWeight;
            }
            if (angular.isDefined($scope.doc.nettWeight) && $scope.doc.nettWeight !== null) {
                obj.Container.nettWeight = $scope.doc.nettWeight;
            }
            if (angular.isDefined($scope.doc.motherVessel) && $scope.doc.motherVessel !== null) {
                obj.motherVsl = $scope.doc.motherVessel;
            }
            if (angular.isDefined($scope.doc.importDue) && $scope.doc.importDue !== null) {
                obj.mvdate = $filter('date')($scope.doc.importDue, "yyyy-MM-dd");;
            }
            if (angular.isDefined($scope.doc.importArrival) && $scope.doc.importArrival !== null) {
                obj.arrival = $scope.doc.importArrival;
            }
            if (angular.isDefined($scope.doc.importGld) && $scope.doc.importGld !== null) {
                obj.gld = $scope.doc.importGld;
            }
            if (angular.isDefined($scope.doc.importContrOut) && $scope.doc.importContrOut !== null) {
                obj.cntrOut = $scope.doc.importContrOut;
            }
            if (angular.isDefined($scope.doc.feederVessel) && $scope.doc.feederVessel !== null) {
                obj.feederVsl = $scope.doc.feederVessel;
            }
            if (angular.isDefined($scope.doc.feederVslOn) && $scope.doc.feederVslOn !== null) {
                obj.fvOn = $filter('date')($scope.doc.feederVslOn, "yyyy-MM-dd");
            }
            if (angular.isDefined($scope.doc.cfs) && $scope.doc.cfs !== null) {
                obj.CFS = $scope.doc.cfs;
            }
            if (angular.isDefined($scope.doc.agents) && $scope.doc.agents !== null) {
                obj.agents = $scope.doc.agents;
            }
            if (angular.isDefined($scope.doc.igmNo) && $scope.doc.igmNo !== null) {
                obj.igmNo = $scope.doc.igmNo;
            }
            if (angular.isDefined($scope.doc.igmDate) && $scope.doc.igmDate !== null) {
                obj.licenseDate = $filter('date')($scope.doc.igmDate, "yyyy-MM-dd");;
            }
            if (angular.isDefined($scope.doc.lineNo) && $scope.doc.lineNo !== null) {
                obj.lineNo = $scope.doc.lineNo;
            }
            if (angular.isDefined($scope.doc.hblNo) && $scope.doc.hblNo !== null) {
                obj.hblNo = $scope.doc.hblNo;
            }
            if (angular.isDefined($scope.doc.hblDate) && $scope.doc.hblDate !== null) {
                obj.hblDate = $filter('date')($scope.doc.hblDate, "yyyy-MM-dd");
            }
            if (angular.isDefined($scope.doc.mbl) && $scope.doc.mbl !== null) {
                obj.mbl = $scope.doc.mbl;
            }
            if (angular.isDefined($scope.doc.mbldate) && $scope.doc.mbldate !== null) {
                obj.mblDate = $filter('date')($scope.doc.mbldate, "yyyy-MM-dd");
            }
            if (angular.isDefined($scope.doc.invoiceValue) && $scope.doc.invoiceValue !== null) {
                obj.invoiceValue = $scope.doc.invoiceValue;
            }
            if (angular.isDefined($scope.doc.CIF) && $scope.doc.CIF !== null && $scope.doc.CIF === true) {
                obj.CIF = $scope.doc.CIF;
            }
            if (angular.isDefined($scope.doc.FOB) && $scope.doc.FOB !== null) {
                obj.FOB = $scope.doc.FOB;
            }
            if (angular.isDefined($scope.doc.CI) && $scope.doc.CI !== null) {
                obj.CI = $scope.doc.CI;
            }
            if (angular.isDefined($scope.doc.CF) && $scope.doc.CF !== null) {
                obj.CF = $scope.doc.CF;
            }

            obj.jobType = JSON.stringify(setGeneralFields());
            return obj;
        }

        function mapDateFields(contains) {
            for (var i = 0; i < contains.length; i++) {
                contains[i].gld = $filter('date')(contains[i].gld, "yyyy-MM-dd");
                contains[i].contrOut = $filter('date')(contains[i].contrOut, "yyyy-MM-dd");
            }
            return contains;
        }

        function setGeneralFields() {
            var jobType = commonService.getGeneralObj();
            if (angular.isDefined($scope.General)) {
                if ($scope.General.Bonding === true) {
                    jobType.Bonding = true;
                }
                if ($scope.General.houseConsumption === true) {
                    jobType.houseConsumption = true;
                }
                if ($scope.General.exbond === true) {
                    jobType.exbond = true;
                }
                if ($scope.General.edi === true) {
                    jobType.edi = true;
                }
                if ($scope.General.bulk === true) {
                    jobType.bulk = true;
                }
                if ($scope.General.deec === true) {
                    jobType.deec = true;
                }
                if ($scope.General.depb === true) {
                    jobType.depb = true;
                }
                if ($scope.General.rms === true) {
                    jobType.rms = true;
                }
                if ($scope.General.openOrder === true) {
                    jobType.openOrder = true;
                }
                if ($scope.General.breakBulk === true) {
                    jobType.breakBulk = true;
                }
            }
            return jobType;
        }

        $scope.saveContainerObj = function () {
            $scope.doc.contains = $scope.doc.containerObj;
            $scope.addedMsg = "Container Saved!";
        };

        $scope.addContainerDetails = function () {
            $scope.doc.containerObj = [];
            for (var i = 0; i < $scope.doc.containerNumber; i++) {
                var container = {
                    containerNo: i + 1,
                    containerName: "",
                    gld: "",
                    contrOut: ""
                };
                $scope.doc.containerObj.push(container);
            }
        };

        $scope.addContainerObj = function () {
            $scope.addedMsg = "";
            $(showContainer).modal("show");
            $scope.editFlag = false;
        };

        $scope.editContainerObj = function () {
            $scope.addedMsg = "";
            $scope.doc.containerObj = $scope.doc.contains;
            $scope.doc.containerNumber = $scope.doc.containerObj.length;
            $(showContainer).modal("show");
            $scope.editFlag = true;
        };
        /* Delete the selected record */
        $scope.removeSelectedContainer = function (id) {
            var index = _.findIndex($scope.doc.containerObj, { containerNo: id });
            if (index !== -1) {
                if (index === 0 && $scope.doc.containerObj.length === 1) {
                    $scope.doc.containerObj = [];
                } else {
                    $scope.doc.containerObj.splice(index, 1);
                }
            }
        };

        $scope.addAdditionalContainer = function () {
            var i = 0;
            if (angular.isArray($scope.doc.containerObj)) {
                i = $scope.doc.containerObj.length + 1;
            }
            var container = {
                containerNo: i,
                containerName: "",
                gld: "",
                contrOut: ""
            };
            $scope.doc.containerObj.push(container);
        };

        $scope.delContainerObj = function () {
            $scope.doc.contains.pop();
        };

        $scope.saveDocFields = function () {
            $scope.alertMsg = "";
            $scope.successMsg = "";
            $scope.errorMsg = "";
            var url = configSevice.getUrl() + "import_sea/import_sea_service.php";
            var obj = commonService.getImportSeaDocObj();
            if ($scope.createFlag) {
                obj = setDocNoFields(obj, "create_import_sea_doc");
                $scope.action = "Created";
            } else {
                obj = setDocNoFields(obj, "update_import_sea_doc");
                obj.id = $routeParams.id;
                $scope.action = "Updated";
            }
            var validate = commonService.saveValidations(obj);
            if (validate.flag === true) {
                http.post(url, obj).then(function (data) {
                    if (angular.isDefined(data.data) && data.data.infocode === "CREATEIMPORTSEADOCSUCCESS" && $scope.createFlag) {
                        $scope.successMsg = "Doc Fields " + $scope.action + " Successfully for " + $scope.doc.importJobNo + " !";
                        $scope.successMsg = data.data.message;
                        if ($scope.createFlag) {
                            $scope.updateFlag = true;
                            $scope.createFlag = false;
                        }
                        // $scope.doc.importJobNo = data.data.doc_id + configSevice.getJobid();
                        $(showSuccess).modal("show");
                    } else if (angular.isDefined(data.data) && data.data.infocode === "UPDATEIMPORTSEADOCSUCCESS" && !$scope.createFlag) {
                        $scope.successMsg = "Doc Fields " + $scope.action + " Successfully for " + $scope.doc.importJobNo + " !";
                        $(showSuccess).modal("show");
                    } else {
                        $scope.errorMsg = data.data.message;
                        $(showError).modal("show");
                    }
                }, function (error) {
                    $scope.error = error;
                });
            } else {
                $scope.alertMsg = validate.msg;
                $(showAlert).modal("show");
            }
        };

        $scope.activeMenu = function (val) {
            if (val == 1) {
                $scope.section1 = true;
                $scope.section2 = false;
                $scope.section3 = false;
                $scope.section4 = false;
                $scope.section5 = false;
                $scope.section6 = false;
                $scope.section7 = false;
                $scope.section8 = false;
                $scope.section9 = false;
            }
            else if (val == 2) {
                $scope.section1 = false;
                $scope.section2 = true;
                $scope.section3 = false;
                $scope.section4 = false;
                $scope.section5 = false;
                $scope.section6 = false;
                $scope.section7 = false;
                $scope.section8 = false;
                $scope.section9 = false;
            }
            else if (val == 3) {
                $scope.section1 = false;
                $scope.section2 = false;
                $scope.section3 = true;
                $scope.section4 = false;
                $scope.section5 = false;
                $scope.section6 = false;
                $scope.section7 = false;
                $scope.section8 = false;
                $scope.section9 = false;
            }
            else if (val == 4) {
                $scope.section1 = false;
                $scope.section2 = false;
                $scope.section3 = false;
                $scope.section4 = true;
                $scope.section5 = false;
                $scope.section6 = false;
                $scope.section7 = false;
                $scope.section8 = false;
                $scope.section9 = false;
            }
            else if (val == 5) {
                $scope.section1 = false;
                $scope.section2 = false;
                $scope.section3 = false;
                $scope.section4 = false;
                $scope.section5 = true;
                $scope.section6 = false;
                $scope.section7 = false;
                $scope.section8 = false;
                $scope.section9 = false;
            }
            else if (val == 6) {
                $scope.section1 = false;
                $scope.section2 = false;
                $scope.section3 = false;
                $scope.section4 = false;
                $scope.section5 = false;
                $scope.section6 = true;
                $scope.section7 = false;
                $scope.section8 = false;
                $scope.section9 = false;
            }
            else if (val == 7) {
                $scope.section1 = false;
                $scope.section2 = false;
                $scope.section3 = false;
                $scope.section4 = false;
                $scope.section5 = false;
                $scope.section6 = false;
                $scope.section7 = true;
                $scope.section8 = false;
                $scope.section9 = false;
            }
            else if (val == 8) {
                $scope.section1 = false;
                $scope.section2 = false;
                $scope.section3 = false;
                $scope.section4 = false;
                $scope.section5 = false;
                $scope.section6 = false;
                $scope.section7 = false;
                $scope.section8 = true;
                $scope.section9 = false;
            }
            else if (val == 9) {
                $scope.section1 = false;
                $scope.section2 = false;
                $scope.section3 = false;
                $scope.section4 = false;
                $scope.section5 = false;
                $scope.section6 = false;
                $scope.section7 = false;
                $scope.section8 = false;
                $scope.section9 = true;
            }
        };

    }]);
